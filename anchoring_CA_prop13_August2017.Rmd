---
title: 'Sunk Costs and Anchoring in the Housing Market'
author: "Dimuthu Ratnadiwakara and Vijay Yerramilli"
date: "July, 2017"
output:
  html_document:
    css: bodycss.css
    fig_width: 8
    font-family: Helvetica,Arial,sans-serif;
    number_section: yes
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
linestretch: 2
bibliography: C:\Users\dnratnadiwakara\OneDrive\library.bib
---

<style type="text/css">
body{ 
      font-size: 15px;
      font-family: Helvetica,Arial,sans-serif;
      line-height: 200%;
  }
  
.author {
 font-size: 15px;
 color: Black;
 font-style: normal;
 text-align: center;
}


.date { 
 font-size: 15px;
 color: Black;
 font-style: normal;
 text-align: center;
}

.title{
  text-align: center;
  font-size: 15px;
 color: Black;
 
}

.toc-ignore{
  text-align: center;
  font-size: 15px;
 color: Black;
}

.fluid-row{
  text-align: center;
  font-size: 15px;
 color: Black;
}

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE,echo = FALSE, fig.align='center')
```




```{r init}

rm(list=ls())
path = "E:/tax_incident/"
setwd(path)
library(plyr)
library(psych)
library(stargazer)
library(Matching)
library(sandwich)
library(ggplot2)
library(scales)
library(lubridate)
library(zoo)
library(AER)
library(lfe)
library(pracma)
library(dplyr)
library(ggmap)
library(reshape2)
library(np)
library(survival)


output.type="text"

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

# sold_data <- readRDS(file="ca_anchoring_11.rds")
# library(zipcode)
# data("zipcode")
# zipcode <- zipcode[,c("zip","state")]
# zipcode$zip <- as.numeric(zipcode$zip)
# sold_data <- merge(sold_data,zipcode,by="zip")
# sold_data <- sold_data[sold_data$state %in% c("CA","IL"),]
# 
# sold_data <- sold_data[sold_data$state %in% c("CA"),]
# 
# 
# sold_data <- sold_data[sold_data$sales_price>=quantile(sold_data$sales_price,0.001,na.rm = TRUE) & sold_data$sales_price<=quantile(sold_data$sales_price,0.999,na.rm = TRUE),]
# sold_data['delete'] <- ifelse(sold_data$Lastremodelyear>sold_data$purchased_year,1,0)
# sold_data <- sold_data[sold_data$delete ==0 | is.na(sold_data$delete),]
# sold_data$delete <- NULL
# 
# sold_data <- sold_data[is.finite(log(sold_data$listing_amount)),]
# sold_data <- sold_data[is.finite(log(sold_data$sales_price)),]
# sold_data <- sold_data[!is.na(sold_data$zip_purchased_year),]
# sold_data <- sold_data[!is.na(sold_data$zip_listed_year),]
# sold_data <- sold_data[sold_data$listed_year>=2013,]
# 
# 
# 
# sold_data <- completeFun(sold_data,c("sales_price","listing_amount","zip_listed_year","purchased_amount","purchased_year"))
# saveRDS(sold_data,file = "sold_data_cleaned_11.rds")

note =c("Fixed Effects: zip x listed year","Standard Errors clustered by zip x listed year")
printtable <- function(reg,column.labels,depvar,note,iv,lines) {
  stargazer(reg,type=output.type,no.space = TRUE,omit.stat = c("f","rsq","ser"),notes= note,column.labels = column.labels, dep.var.labels = "",dep.var.caption   = paste("Y: ",gsub("_"," ",depvar),"; iv: ",gsub("_"," ",iv)),dep.var.labels.include = FALSE,add.lines = lines)
}

# sold_data <- readRDS(file = "sold_data_cleaned_11.rds")
# 
# sold_data['listed_tax'] <- ifelse(sold_data$listed_year>=2016,sold_data$proptax_2015,ifelse(sold_data$listed_year==2015,sold_data$proptax_2014,ifelse(sold_data$listed_year==2014,sold_data$proptax_2013,sold_data$proptax_2012)))
# 
# sold_data <- sold_data[!is.na(sold_data$listed_tax),]
# sold_data['estimated_current_value'] <- sold_data$current_value # current value = purchasedprice*hpi/hpi
# sold_data['degree_of_overpricing'] <- (sold_data$listing_amount / sold_data$estimated_current_value)
# sold_data['tax_pct'] <- sold_data$listed_tax/sold_data$estimated_current_value
# 
# sold_data <- sold_data[!(sold_data$listed_tax > quantile(sold_data$listed_tax,0.99,na.rm = TRUE) | sold_data$sales_price > quantile(sold_data$sales_price,0.99,na.rm = TRUE) | sold_data$listing_amount > quantile(sold_data$listing_amount,0.99,na.rm = TRUE) | sold_data$estimated_current_value > quantile(sold_data$estimated_current_value,0.99,na.rm = TRUE) | sold_data$listed_tax < quantile(sold_data$listed_tax,0.01,na.rm = TRUE) | sold_data$sales_price < quantile(sold_data$sales_price,0.01,na.rm = TRUE) | sold_data$listing_amount < quantile(sold_data$listing_amount,0.01,na.rm = TRUE) | sold_data$estimated_current_value < quantile(sold_data$estimated_current_value,0.01,na.rm = TRUE)), ]
# 
# sold_data <- sold_data[!is.na(sold_data$estimated_current_value),]
# 
# sold_data <- sold_data[sold_data$degree_of_overpricing>=quantile(sold_data$degree_of_overpricing,0.02,na.rm = TRUE) & sold_data$degree_of_overpricing<=quantile(sold_data$degree_of_overpricing,0.98,na.rm = TRUE) & sold_data$tax_pct>=quantile(sold_data$tax_pct,0.03,na.rm = TRUE) & sold_data$tax_pct<=quantile(sold_data$tax_pct,0.97,na.rm = TRUE),]
# 
# 
# inventory_data <- read.csv(paste("InventoryMeasure_Zip_Public.csv",sep=""))
# inventory_data <- data.frame(inventory_data[1],stack(inventory_data[2:ncol(inventory_data)]))
# names(inventory_data) <- c("month","inventory","zip")
# inventory_data$month <- as.Date(as.character(inventory_data$month))
# inventory_data$zip <- as.character(inventory_data$zip)
# inventory_data$zip <- as.integer(substr(inventory_data$zip,2,nchar(inventory_data$zip)))
# inventory_data['listed_year'] <- as.numeric(format(inventory_data$month,"%Y"))
# inventory_data <- inventory_data[inventory_data$zip %in% unique(sold_data[sold_data$state=="CA",]$zip),]
# inventory_data <- inventory_data[inventory_data$listed_year %in% unique(sold_data[sold_data$state=="CA",]$listed_year),]
# inventory_data <- ddply(inventory_data,.(listed_year,zip),summarise,inventory = mean(inventory,na.rm = TRUE))
# inventory_data['inventory_decile'] <- ntile(inventory_data$inventory, 10)
# 
# sold_data$inventory <- NULL
# sold_data$inventory_decile <- NULL
# 
# sold_data <- merge(sold_data,inventory_data,by=c("listed_year","zip"),all.x = TRUE)
# sold_data <- sold_data[sold_data$beds<8,]
# sold_data <- sold_data[sold_data$sqft<10000,]
# 
# sold_data['zip_listed_month'] <- paste(sold_data$zip,sold_data$listed_month)
# 
# 
# 
# 
# 
# 
# # rowno <- 1
# pb <- txtProgressBar(min = 1, max = nrow(sold_data), initial = 1,style=3,char = ".")
# for(i in 1:nrow(sold_data)) {
#     setTxtProgressBar(pb, i)
#     start = sold_data[i,]$purchased_year+2
#     end = sold_data[i,]$listed_year-1
#     if(is.na(start) | is.na(end)) next
#     if(start<=2004) next
#     if(end>start) {
#       for(j in start:(end-1)) {
# 
#         try({
#           eval(parse(text=paste("if(is.na(sold_data[i,]$assesment_",j,") | is.na(sold_data[i,]$assesment_",(j-1),")) next",sep="")))
#           eval(parse(text=paste("if(sold_data[i,]$assesment_",j,"==0 | sold_data[i,]$assesment_",(j-1),"==0) next",sep="")))
#           eval(parse(text=paste("sold_data[i,'gr_",j,"']=sold_data[i,]$assesment_",j,"/sold_data[i,]$assesment_",(j-1),"-1",sep="")))
#         },{})
#       }
#     }
# }
# 
# 
# # sold_data$gr_2005 <- floor(sold_data$gr_2005*1000)/1000
# # sold_data$gr_2006 <- floor(sold_data$gr_2006*1000)/1000
# # sold_data$gr_2007 <- floor(sold_data$gr_2007*1000)/1000
# # sold_data$gr_2008 <- floor(sold_data$gr_2008*1000)/1000
# # sold_data$gr_2009 <- floor(sold_data$gr_2009*1000)/1000
# # sold_data$gr_2010 <- floor(sold_data$gr_2010*1000)/1000
# # sold_data$gr_2011 <- floor(sold_data$gr_2011*1000)/1000
# # sold_data$gr_2012 <- floor(sold_data$gr_2012*1000)/1000
# # sold_data$gr_2013 <- floor(sold_data$gr_2013*1000)/1000
# # sold_data$gr_2014 <- floor(sold_data$gr_2014*1000)/1000
# # sold_data$gr_2015 <- floor(sold_data$gr_2015*1000)/1000
# 
# 
# sold_data['prop8_affected'] <- ifelse((sold_data$gr_2008 > 0.0 | is.na(sold_data$gr_2008) ) & (sold_data$gr_2009 >0 | is.na(sold_data$gr_2009)) & (sold_data$gr_2010 > -0.004 | is.na(sold_data$gr_2010)) & (sold_data$gr_2011 >0 | is.na(sold_data$gr_2011)) & (sold_data$gr_2012 <= 0.03 | is.na(sold_data$gr_2012)) & (sold_data$gr_2013 <= 0.03 | is.na(sold_data$gr_2013)) & (sold_data$gr_2014 <= 0.03 | is.na(sold_data$gr_2014)),0,1)
# 
# saveRDS(sold_data,file = "sold_data_cleaned_12_cleaned_1.1.rds")
# # sold_data['prop8_affected'] <- ifelse((sold_data$gr_2008 < -0.03 & !is.na(sold_data$gr_2008) ) & (sold_data$gr_2009 < -0.03 & !is.na(sold_data$gr_2009)) & (sold_data$gr_2010 <= -0.03 & !is.na(sold_data$gr_2010)) & (sold_data$gr_2011 < -0.03 & !is.na(sold_data$gr_2011)) & (sold_data$gr_2012 > 0.03 & !is.na(sold_data$gr_2012)) & (sold_data$gr_2013 >0.03 & !is.na(sold_data$gr_2013)) & (sold_data$gr_2014 >0.03 & !is.na(sold_data$gr_2014)),1,0)
# 
# pb <- txtProgressBar(min = 1, max = nrow(sold_data), initial = 1,style=3,char = ".")
# for(i in 1:nrow(sold_data)){
#   setTxtProgressBar(pb, i)
#   if(sold_data[i,]$prop8_affected==0) {
#     start = max(sold_data[i,]$purchased_year,2005)
#     end = sold_data[i,]$listed_year
#     if(is.na(start)) next
#     if(is.na(end)) next
#     for(yr in start:end) {
#       gr = 0.02
#       if(yr==2010) gr = -0.0024
#       if(yr==2011) gr = 0.0075
#       if(yr==2014) gr = 0.0045
#       gr_0 <- eval(parse(text=paste("sold_data[i,'gr_",yr,"'] ",sep="")))
#       if(length(gr_0)==0) gr_0 = gr
#       if(!is.na(gr_0)) gr = gr_0
#       eval(parse(text=paste("sold_data[i,'gr_",yr,"'] = ",gr,sep="")))
#     }
#   }
# }

# sold_data$sqft <- rnorm(nrow(sold_data),mean(sold_data$sqft,na.rm=TRUE),sd(sold_data$sqft,na.rm = TRUE))
# saveRDS(sold_data,file = "sold_data_cleaned_12_cleaned_2.rds")

sold_data<-readRDS(file = "sold_data_cleaned_12_cleaned_1.1.rds")

# stargazer(sold_data[sold_data$prop8_affected==0 | is.na(sold_data$prop8_affected), c("gr_2006","gr_2007","gr_2008","gr_2009","gr_2010","gr_2011","gr_2012","gr_2013","gr_2014","gr_2015")], type = output.type, summary.stat = c("p25", "median", "p75","min","max", "n"),notes = "",digits = 4)
# 
# sold_data <- completeFun(sold_data,c("sales_price","beds","baths","sqft","zip_listed_year","purchased_amount","purchased_hpi","Lot","walk_score","avg_school_rating","avg_school_distance","zip_purchased_year","age"))
# 
# sales_price_estimate <- felm(sales_price~age+sqft+beds+listed_hpi,data=sold_data)
# sold_data['predicted_sales_price'] <- sales_price_estimate$fitted.values
# 
# purchased_price_estimate <- felm(purchased_amount~age+sqft+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|factor(zip_purchased_year),data=sold_data)
# sold_data['purchase_price_residual'] <- purchased_price_estimate$residuals
# 
# sold_data$predicted_sales_price <- (sold_data$predicted_sales_price*0.55+sold_data$estimated_current_value*0.45)
# 

sold_data['nominal_loss'] <- sold_data$purchased_amount - sold_data$estimated_current_value
```

```{r}
table(sold_data$prop8_affected)

t1 <- sold_data[sold_data$prop8_affected==1,]
stargazer(t1[, c("gr_2006","gr_2007","gr_2008","gr_2009","gr_2010","gr_2011","gr_2012","gr_2013","gr_2014","gr_2015")], type = output.type, summary.stat = c("p25", "median", "p75", "n"),notes = "",digits = 4)

t2 <- sold_data[sold_data$prop8_affected==0,]
stargazer(t2[, c("gr_2006","gr_2007","gr_2008","gr_2009","gr_2010","gr_2011","gr_2012","gr_2013","gr_2014","gr_2015")], type = output.type, summary.stat = c("p25", "median", "p75", "n"),notes = "",digits = 4)
```

```{r fill_missing_proptax}

# temp <- sold_data
# 
# 
# summarydata <- matrix(nrow = nrow(temp)*10, ncol = 3)
# 
# rowno <- 1
# pb <- txtProgressBar(min = 1, max = nrow(temp), initial = 1,style=3,char = ".")
# for(i in 1:nrow(temp)) {
#     setTxtProgressBar(pb, i)
#     start = max(temp[i,]$purchased_year+1,2004)
#     end = temp[i,]$listed_year-1
#     if(is.na(start) | is.na(end)) next
#     if(end>start) {
#       for(j in start:(end-1)) {
#         # appr <- eval(parse(text=paste("temp[i,]$assesment_",j,"/temp[i,]$assesment_",(j-1),"-1",sep="")))
#         tax_rate <- eval(parse(text=paste("temp[i,]$proptax_",j,"/temp[i,]$assesment_",j,sep="")))
#         if(length(tax_rate)==0) next
#         if(length(tax_rate)==0 | is.na(tax_rate) | tax_rate==0 | !is.finite(tax_rate)) next
#      
#         # if(appr>0.022 | tax_rate>0.011 | tax_rate<=0 ) next
#         # appr <- min(0.02,appr)
#         # tax_rate <- min(0.01,tax_rate)
#         summarydata[rowno,] <- c(temp[i,]$zip,j,tax_rate)
#         rowno = rowno+1
#       }
#     }
# 
# }
# summarydata <- as.data.frame(summarydata)
# names(summarydata) <- c("zip","year","tax_rate")
# summarydata <- summarydata[!is.na(summarydata$zip),]
# 
# summarydata <- ddply(summarydata,.(zip,year),summarise,tax_rate = median(tax_rate,na.rm = TRUE))
# 
# saveRDS(summarydata,file=paste(path,"zipcode_tax_summary_2.rds",sep=""))


# 
# zip_code_summary <- readRDS(file=paste(path,"zipcode_tax_summary_2.rds",sep=""))
# pb <- txtProgressBar(min = 1, max = nrow(sold_data), initial = 1,style=3,char = ".")
# rownos <- which(is.na(sold_data$proptax_2010)|sold_data$proptax_2010==0)
# rownos <- rownos[rownos>34825]
# for(i in rownos){
#   cat(i," ")
#   # setTxtProgressBar(pb, i)
#   for(yr in c(2004:2015)) {
#     # cat(yr)
#     tryCatch({
#       eval(parse(text=paste("if((is.na(sold_data[i,]$proptax_",yr,") | (sold_data[i,]$proptax_",yr,"==0)) & !is.na(sold_data[i,]$assesment_",yr,") & sold_data[i,]$assesment_",yr,">0) {tax_rate <- zip_code_summary[zip_code_summary$year==",yr," & zip_code_summary$zip==sold_data[i,]$zip,]$tax_rate;sold_data[i,]$proptax_",yr," = tax_rate*sold_data[i,]$assesment_",yr,"}",sep='')))
#     },error=function(err){})
#   }
# }
# 
# 
# temp <- sold_data
# temp['property_tax_paid']<-NA
# for(i in 1:nrow(temp)) {
#   cat(i," ")
#   start <- temp[i,]$purchased_year
#   end <- temp[i,]$listed_year-1
#   total_tax = 0
#   tryCatch({
#   for(yr in start:end) {
#     eval(parse(text=paste("total_tax = total_tax+temp[i,]$proptax_",yr,sep='')))
#   }
#   temp[i,]$property_tax_paid = total_tax
#   },error=function(err){})
# }
# saveRDS(temp,file=paste(path,"cleanedcleaned_July17.rds",sep=""))


# temp['loss'] <- temp$purchased_amount - temp$predicted_sales_price
```


# Research Questions

* Do home sellers list prices higher when the sunk costs are greater?
* Are sellers faced with prospective losses more sensitive to sunk cost?
* Do buyers use initial list price in home sales as an anchor to judge the value of a property?

# Related Literature

* According to traditional microeconomic theory, sunk costs should not influence the seller's listing price. However, evidence from behavioral economics (Knox and Inkster (1968), Staw and Fox (1976),Arkes and Blumer (1985), Whyte (1986)) suggest that sunk costs do, in fact, influence people's decisions because humans are prone to loss aversion and framing effects ((Kahneman and Tverksy 1979, Tversky and Kahneman 1991)
* According Tversky and Kahneman (1986), a reason people fall prey to the sunk cost fallacy is loss aversion: People tend to have a much stronger preference for avoiding losses than for acquiring gains. To explain loss aversion with prospect theory, Tversky and Kahneman (1991) suggest that there are three essential components that help explain how individuals make choices under uncertainity. First gains and losses are examined relative toa reference point. Second, the value function is steeper for losses than for equivalently sized gaints. Third, the marginal value of gains or losses diminishes with the size of the gain or loss.
* The psychological litrature on the "anchorin-and-adjustment" heuristic suggests that (a) an arbitrarily chosen reference point (anchor) will significantly infuence value estimates, and (b) value estimates will be insufficiently adjusted away from the reference point toward the true value of the object estimation (Slovic & Lichtenstein, 1971). Tversky and Kahneman (1974) first demonstrated this effect using a behavioral experiment. 
* Genesove and Mayer (2001) find strong evidence of loss aversion in the context of the Boston condominium market between 1990 and 1997. Anenberg (2011) analyses the San Francisco Bay Area housing market and reports significant effects of loss aversion on transaction prices (i.e. anchoring). Bokhari and Geltner (2011) concludes that loss aversion behavior plays a major role in the pricing of corporate properties. They also document a possible anchoring effect. 
* Northcraft and Neale (1987) show using an experimental study that over-or underpricing by a seller could influence a buyer's valuation and thus have an effect on the subsequent transaction price. Black and Diaz (1996) found in a laboratory experiment that manipulation of the asking price influenced the buyer's opening offer and eventual transaction price. 
* Bracke and Tenreyro (2017) show that sale prices and selling probabilities today are affected by aggregate house prices prevailing in the period in which properties were previously bought. 
* Choi, Hong and Scheinkman (2014) show that likelihood of home improvements and renovations is correlated with aggregate house prices. => Bracke and Tenreyro (2017) estimates could still be biased despite them using house price index as an instrument
* Stein (1995) - down-payment effect. For repeat buyers, a large percentage of their downpayment comes from the sale of their previous homes. Therefore owners who bought at high prices will have limited home equity and will have higher reservation prices.
* Genesove and Mayer (1997) show that owners with high loan-to-value (i.e. low equity) take longer to sell their properties than owners with low loan-to-value rations. Properties with high loan-to-value ratios are listed at higher asking prices; when sold, they receive higher prices than units with less debt.
* Yavas and Yang (1995) propose a game theoretic model in which they argue that a seller strategically lists an asking price that reflects his or her bargaining power in an attempt to signal to certain types of buyers.
* Glower, Haurin and Hendershott (1998) find that a seller who has a planned date to move will over-rice less and sell more quickly than a seller with no definite move date. A seller who is willing to move later will over-price more and sell more slowly than a seller who wants to move sooner.
* Springer (1996) show selling price discounts for houses with sellers who are motivated, anxious, who have relocated, foreclosures and vacant houses. 
* Levitt and Syversion (2008) - Real estate agents have an incentive to convince clients to sell their houses too cheaply and too quickly.
* Knight (2002) - Homes whose list prices were revised took longer to sell and sold for less than homes that were initially priced "correctly"



# Data 

* Primary data source is Zillow.com. 
* Listing data for a sample of recently sold homes in California.
* Data includes house characteristics, neighborhood characteristics, price history and tax history. House characteristics include information such as number of bedrooms, bathrooms, square footage, lot size and age. Neihgborhood characteristics include school ratings from greatschools blog, distance to school, walkability to the closest amenities and availability of public transportation. Price history includes purchased price, purchased date, listed for sale date, listed price, price changes, whether listing was removed without a sale, or sales price and date if the transaction is succesful. Tax data gives the assesment value and tax amount each year from year 2004. 

## Key Variables

<b>House Value:</b> $$ HouseValue_l = PurchasedPrice_p * HPI_l/HPI_p$$ where l=listing month and p = purchased month. HPI is the zip code level median house value. <br/>

<b>Tax Rate:</b> $$ TaxRate_l = TaxAmount_{l-1}/HouseValue_l $$<br/>

<b>Degree of overpricing:</b>  $$ \frac{listprice}{HouseValue_l} $$<br/>

<b>Time on Market:</b> $$SoldDate - ListDate$$<br/>

<b>Succesful Listing:</b> Whether listing resulted in a sale <br/>


## Descriptive Statistics

This table provides descriptive statistics of the main sample-a sample of recently sold houses in California.
```{r descriptivestats}
temp <- sold_data[sold_data$state %in% c("CA"),]
temp<- temp[is.finite(temp$degree_of_overpricing),]
temp<- temp[is.finite(log(temp$estimated_current_value)),]
temp['property_tax_paid'] <- ifelse(temp$purchased_year<=2011,temp$listed_tax*5,NA)
temp['list_price_adj_purch_price'] <- temp$listing_amount/temp$current_value
temp['list_price_trans_price'] <- temp$listing_amount/temp$sales_price
temp['prop_tax_adj_purch_price'] <- temp$property_tax_paid/temp$current_value
temp['list_hpi_purch_hpi'] <- temp$listed_hpi/temp$purchased_hpi
temp['years_since_remodel'] <- temp$listed_year - temp$Lastremodelyear
# temp <- temp[temp$degree_of_overpricing>=quantile(temp$degree_of_overpricing,0.02,na.rm = TRUE) & temp$degree_of_overpricing<=quantile(temp$degree_of_overpricing,0.98,na.rm = TRUE),]



stargazer(temp[, c("purchased_amount","current_value","listing_amount","sales_price","list_price_adj_purch_price","list_price_trans_price","property_tax_paid","prop_tax_adj_purch_price","prop8_affected","purchased_hpi","list_hpi_purch_hpi","ownership_years","years_since_remodel","beds","baths","sqft","avg_school_rating","avg_school_distance","age","Lot")], type = output.type, summary.stat = c("mean", "sd", "p25", "median", "p75", "n"),notes = "",digits = 4)
```

```{r within_zip_cor}
require(plyr)
correl <- function(xx)
{
return(data.frame(COR = cor(xx$purchased_hpi, xx$listed_hpi, use="pairwise.complete.obs")))
}

cor_group <- ddply(sold_data[,c("purchased_hpi","listed_hpi","zip")], .(zip), correl)
```


# Identification Strategy

* The exogenous property tax component due to Proposition 13 in California is used as an instrument to solve the main identification problem - the correlation between price and unobserved housing, seller and agent characteristics.

## California Proposition 13
Proposition 13, which is officially called the People's Initiative to Limit Property Taxation, was enacted in 1978 and it limits the maximum amount of tax on real property to be 1% and annual increase in the assesment value to 2%. A reassesment of the property is allowed only following an ownership change or new construction[@Oakland1979]. This leads to a situation where two similar houses in the same community whose residents have access to the same bundle of local public services paying significantly different tax amounts. The residents in the house that was purchased when the house prices are higher gets a larger tax bill compared to the residents in a similar house in the same community which was purchased way back when the house prices were low. According to the California Constitution, Article XIIIa, Proposition 13 states that “the maximum amount of any ad valorem tax on real property shall not exceed one percent (1%) of the full cash value of such property”. Full cash value means price at the time of purchase plus a maximum inflation adjustment of 2% per year. No re- assessment could be carried out, implying that property taxes are effectively frozen (apart from the 2% per year rise). Also, the initial base values used to set property taxes were the assessed housing values of 1975/1976


Table
Following example of two very similar houses in Anaheim California which were sold recently shows how past purchases impact the property taxes. Both these houses were sold for similar amounts in 2014. Both houses have 3 bedrooms and 2 bath rooms and both were built in 1955. Observable characteristics of these two houses are as follows.

|620 S Hacienda St|640 S Hacienda St|
|---------------|---------------|
|3 beds, 2 baths|3 beds, 2 baths|
|1,336 sqft|1,314 sqft|
|Built in 1955|Built in 1955|
|Previouse Sales 2005 (\$482,000), 2010 (320,000)|None|
|Sales Price \$ 450,000 (2014)|Sales Price \$ 435,000 (2014)|

![Figure 1: Two recently sold houses in Anaheim, CA](C:/Users/dnratnadiwakara/OneDrive/taxincidence/map2.png)

Following figure shows the annual property taxes for two very similar houses in Anaheim California. Both houses were sold in 2014 for similar amounts. House 1(620 S Hacienda St) was sold twice in the past during the sample period in 2005 for \$482,000 and in 2010 for \$435,000. House 2 (640 S Hacienda St) was sold for the first time in 2014.

```{r example}
years <- 2005:2016
house1 <- c(3479,5429,5429,5625,3815,3815,3815,3867,3867,3928,5550,5550)
house2 <- c(679,679,714,737,776,914,914,982,982,974,5288,5288)
temp <- rbind(years,house1)
temp <- as.data.frame(t(rbind(temp,house2)))
ggplot(temp,aes(x=years))+ geom_line(aes(y=temp$house1,color="620 S Hacienda St"))+ geom_line(aes(y=temp$house2,color="640 S Hacienda St"))+labs(y = "Properyt Taxes ($)",x = "Tax Year",colour = NULL)+ theme_bw()+theme(legend.position="bottom",legend.direction="horizontal",legend.title=element_blank(),        axis.ticks.y=element_blank(),legend.key.width=unit(5,"line"),legend.key = element_blank())+scale_x_continuous(breaks=years) 

```

## Property Taxes and House Prices in California

This figure shows the relationship between the property tax rate in 2015 and the median house price in the zip code at the time of purchase in California. Tax rate is defined as the property taxes paid in 2015 as a percentage of estimated home value in 2015. Home value is estimated by inflating the purchased price by house price appreciation rate from purchased year to year 2015.

```{r ca_graph}
temp <- sold_data[sold_data$state %in% c("CA"),]
# temp <- temp[temp$tax_pct>=quantile(temp$tax_pct,0.05,na.rm = TRUE) & temp$tax_pct<=quantile(temp$tax_pct,0.95,na.rm = TRUE),]
temp['purchased_quarter'] <- as.yearqtr(temp$purchased_date)
temp <- temp[temp$purchased_year <=2011 ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp$property_tax_paid <- temp$property_tax_paid/temp$current_value
temp <- ddply(temp,.(purchased_quarter),summarise,proptax_2015 = mean(proptax_2015),estimated_current_value=mean(estimated_current_value),taxpct = mean(property_tax_paid*100),hpi=mean(purchased_hpi,na.rm=TRUE))
# stargazer((temp),summary = FALSE,type=output.type)
# temp <- temp[,c("purchased_year","taxpct","hpi")]
g1 <- ggplot(temp,aes(x=purchased_quarter))+ geom_line(aes(y=temp$taxpct,color="Tax Rate"))+ geom_line(aes(y=temp$hpi/100000,color="Median House Price"))+scale_linetype_manual(values = c(rep("solid", 1), rep("dashed", 1)))+ scale_y_continuous(sec.axis = sec_axis(~.*100, name = "Median House Price $'000"))+labs(y = "Tax Rate (%)",x = "Purchased Year",colour = NULL)+ theme_bw()+theme(legend.position="bottom",legend.direction="horizontal",legend.title=element_blank(),        axis.ticks.y=element_blank(),legend.key.width=unit(5,"line"),legend.key = element_blank())+ggtitle("")
g1
```



Following figure shows the histogram of within zip code tax rate variation. Tax rate for each house is calculated by dividing the property tax amount in the year prior to listing by the estimated house value in the year of listing. X-axis is the difference between the tax rate of each house and the mean tax rate of each zip code.

```{r hist_tax_pct}
temp <- sold_data[sold_data$state %in% c("CA") ,]
temp<- temp[is.finite(temp$degree_of_overpricing),]
temp<- temp[is.finite(log(temp$estimated_current_value)),]
temp <- temp[temp$purchased_year <=2011  ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp$tax_pct = temp$property_tax_paid/temp$current_value
zip_tax_rate <- ddply(temp,.(zip),summarise,mean_tax_rate = mean(tax_pct))
temp <- merge(temp,zip_tax_rate,by=c("zip"))
temp['tax_variation'] <- temp$tax_pct-temp$mean_tax_rate
q1<-qplot(temp$tax_variation,geom="histogram",xlab="Tax Rate - Mean ZIP Tax Rate",ylab="Number of Listings",col=I("black"))+ theme_bw()+xlim(-0.03,0.03)
q1
```


## Balancing Tests
```{r balancing_tests}


temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*1
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>1000 & temp$property_tax_paid <200000,]


dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

# temp <- temp[temp$degree_of_overpricing>=quantile(temp$degree_of_overpricing,0.02,na.rm = TRUE) & temp$degree_of_overpricing<=quantile(temp$degree_of_overpricing,0.98,na.rm = TRUE) & temp$tax_pct>=quantile(temp$tax_pct,0.02,na.rm = TRUE) & temp$tax_pct<=quantile(temp$tax_pct,0.98,na.rm = TRUE),]
temp['std_degree_of_overpricing']<- (temp$degree_of_overpricing - mean(temp$degree_of_overpricing,na.rm=TRUE))/sd(temp$degree_of_overpricing,na.rm=TRUE)
temp['std_tax_pct']<- (temp$tax_pct - mean(temp$tax_pct,na.rm=TRUE))/sd(temp$tax_pct,na.rm=TRUE)
temp$age <- abs(temp$age)+1
# temp['zip_listed_year']<- paste(temp$zip,as.yearqtr(temp$listed_date))
# temp['zip_purchased_year']<- paste(temp$zip,as.yearqtr(temp$purchased_date))

# formula_text <- "~0|zip_listed_year|(std_degree_of_overpricing~tax_pct)|zip_listed_year"
formula_text <- "|zip_listed_month|0|zip_listed_month"

temp$property_tax_paid <- temp$property_tax_paid/temp$estimated_current_value
variables <- c("beds","baths","sqft","Lot","age","log(sales_price)","log(purchased_hpi)","ownership_years")
i = 1
felm_regs <- list()
for(variable in variables) {
  # print(i)
  # if(variable == "purchased_hpi") {
  #   # temp <- temp[temp$degree_of_overpricing<1.5 & temp$degree_of_overpricing>0.55,]
  #   temp <- temp[temp$tax_pct<0.2 & temp$tax_pct>0.0001,]
  #   # temp <- rbind(temp,temp[sample(nrow(temp), 9000), ])
  # }
  felm_regs[[i]] <- felm(as.formula(paste("I(property_tax_paid*100)~",variable,formula_text,sep="")),data=temp)
  i=i+1
}

stargazer(felm_regs,type = output.type,no.space = TRUE,column.labels = gsub("_","",variables),notes = note,omit.stat = c("rsq"))
```


# Results

## Sunk Cost



### Sunk Cost Paper Tables

```{r sunk_cost_panel_A}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>0 & temp$property_tax_paid <2000000,]
temp['list_purch_hpi'] <- temp$listed_hpi/temp$purchased_hpi
temp['ownership_days'] <- as.numeric(temp$listed_date - temp$purchased_date)



dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+log(ownership_days)"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"
controls2 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"


regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~prop8_affected+",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==0,])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","Prop.8 = 0","Prop.8 = 1"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```


```{r sunk_cost_panel_A_robustness}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]
temp['list_purch_hpi'] <- temp$listed_hpi/temp$purchased_hpi
temp['purchased_quarter'] <- as.yearqtr(temp$purchased_date)
temp['ownership_days'] <- as.numeric(temp$listed_date - temp$purchased_date)

# temp <- completeFun(temp,c("sales_price","beds","baths","sqft","zip_listed_year","purchased_amount","purchased_hpi","Lot","walk_score","avg_school_rating","avg_school_distance","zip_purchased_year","age"))
purchased_price_estimate <- felm(purchased_amount~age+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|factor(zip_purchased_year),data=temp)
temp['purchase_price_residual'] <- purchased_price_estimate$residuals

sales_price_estimate <- felm(sales_price~age+sqft+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance+listed_hpi|zip+listed_month,data=temp)
# temp$predicted_sales_price <- sales_price_estimate$fitted.values
temp['loss'] <- temp$purchased_amount - temp$predicted_sales_price



prop_tax_paid_reg <- felm(property_tax_paid~loss+log(predicted_sales_price)+I(purchase_price_residual*100000)+log(ownership_days)+log(listed_hpi)|zip+listed_month,data=temp)

temp['prop_tax_resid'] <- prop_tax_paid_reg$residuals

dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
# endo_var = "I(prop_tax_resid/1e4)"
instrument = "log(purchased_hpi)+ownership_days"
instrument1 = "log(purchased_hpi)"
cluster_var = "zip_listed_month"


controls2 <- "log(loss)+log(predicted_sales_price)+I(purchase_price_residual*100000)+log(list_purch_hpi)|zip+listed_year"


temp$loss <- abs(temp$loss)
regs <- list()

regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi,])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi,])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<temp$listed_hpi,])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<temp$listed_hpi,])

# regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi,])
# 
# regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<temp$listed_hpi,])
# regs[[4]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi,])

# condf <- c("Cond. F. Stat",round(condfstat(regs[[1]])[[1]],2),round(condfstat(regs[[2]])[[1]],2),round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("OLS Loss","IV Loss","OLS Non Loss","IV Non Loss"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(""))
```

```{r sunk_cost_panel_A_split_by_year}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]
temp['ownership_days'] <- as.numeric(temp$listed_date - temp$purchased_date)
instrument = "log(purchased_hpi)+ownership_days"



years <- c(2004:2011)
cluster_var = "0"

controls <- "log(estimated_current_value)+age+beds+baths+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_year"
i = 1
regs <- list()
for(yr in years){
  temp$property_tax_paid <- temp$listed_tax*(2016-yr)
  regs[[i]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_year==yr & temp$listed_year>=2014,])
  i=i+1
}

# regs[[1]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~ownership_days)|",cluster_var,sep="")),data = temp[temp$purchased_year<=1997 & temp$listed_year>=2014,])

printtable(regs,c(as.character(years)),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(""))
```

```{r sunk_cost_panel_B}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

temp$degree_of_overpricing <- temp$listing_amount/temp$estimated_current_value
temp$tax_rate <- temp$property_tax_paid/temp$estimated_current_value

dependent_var = "degree_of_overpricing"
endo_var = "tax_rate"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~prop8_affected+",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==0,])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","Prop.8 = 0","Prop.8 = 1"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```

```{r sunk_cost_panel_C}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

temp$degree_of_overpricing <- temp$listing_amount/temp$sales_price
temp$tax_rate <- temp$property_tax_paid/temp$sales_price

dependent_var = "degree_of_overpricing"
endo_var = "tax_rate"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_year"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==0,])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","Prop.8 = 0","Prop.8 = 1"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```

```{r sunk_cost_loss_split}

setwd(path)

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument1 = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls1 <- "log(estimated_current_value)+prop8_affected+nominal_loss+I(sqft^2)+age+baths+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"
controls2 <- "log(estimated_current_value)+prop8_affected+nominal_loss+I(sqft^2)+age+baths+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

# hpi <- read.csv("Zip_Zhvi_SingleFamilyResidence.csv")
# hpi <- data.frame(hpi[2], stack(hpi[8:ncol(hpi)]))
# names(hpi)<-c("zip","2009_hpi","month")
# hpi <- hpi[hpi$zip %in% unique(temp$zip),]
# hpi$month <- as.Date(paste(substr(hpi$month,2,5),substr(hpi$month,7,8),"01",sep = "-"))
# hpi <- hpi[hpi$month>="2009-09-01" & hpi$month <="2009-12-31",]
# hpi['hpi_2009']<- hpi$`2009_hpi`
# hpi <- ddply(hpi,.(zip),summarise,hpi_2009 = mean(hpi_2009))
# temp <- merge(temp,hpi,by="zip")

instrument2 = "log(purchased_hpi)+ownership_years"
cluster_var = "listed_month"

# controls0 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year+zip_purchased_year"
# controls1 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year"
# controls2 <- "log(estimated_current_value)+sqft+age+beds+baths+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi ,])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument2,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi  ,])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls1,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls1,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
# regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls0,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi & temp$purchased_year %in% c(2004:2011),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Loss-OLS","Loss-IV","No Loss-OLS","No Loss-IV"),depvar = dependent_var,note = c("Fixed Effects: listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))


```


```{r sunk_cost_liquidity_split}
temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+prop8_affected+nominal_loss+I(sqft^2)+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Low Liquidity OLS","Low Liquidity IV","High Liquidity OLS","High Liquidity IV"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list("condf"))

```

```{r sunk_cost_on_transaction_price}
temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>0 & temp$property_tax_paid <200000,]


dependent_var = "log(sales_price)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

controls <- "log(predicted_sales_price)+age+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"


controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"


regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~prop8_affected+",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==0,])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","Prop.8 = 0","Prop.8 = 1"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```

```{r proptax_on_transprice_hpi_split}
setwd(path)

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

dependent_var = "log(sales_price)"
endo_var = "log(property_tax_paid)"
instrument1 = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls1 <- "log(estimated_current_value)+prop8_affected+age+baths+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"
controls2 <- "log(estimated_current_value)+prop8_affected+age+baths+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

# hpi <- read.csv("Zip_Zhvi_SingleFamilyResidence.csv")
# hpi <- data.frame(hpi[2], stack(hpi[8:ncol(hpi)]))
# names(hpi)<-c("zip","2009_hpi","month")
# hpi <- hpi[hpi$zip %in% unique(temp$zip),]
# hpi$month <- as.Date(paste(substr(hpi$month,2,5),substr(hpi$month,7,8),"01",sep = "-"))
# hpi <- hpi[hpi$month>="2009-09-01" & hpi$month <="2009-12-31",]
# hpi['hpi_2009']<- hpi$`2009_hpi`
# hpi <- ddply(hpi,.(zip),summarise,hpi_2009 = mean(hpi_2009))
# temp <- merge(temp,hpi,by="zip")

instrument2 = "log(purchased_hpi)+ownership_years"
cluster_var = "listed_month"

# controls0 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year+zip_purchased_year"
# controls1 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year"
# controls2 <- "log(estimated_current_value)+sqft+age+beds+baths+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi ,])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument2,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi  ,])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls1,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls1,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
# regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls0,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi & temp$purchased_year %in% c(2004:2011),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Loss-OLS","Loss-IV","No Loss-OLS","No Loss-IV"),depvar = dependent_var,note = c("Fixed Effects: listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```

```{r proptax_on_transprice_liquidity_split}
temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

dependent_var = "log(sales_price)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+prop8_affected+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Low Liquidity OLS","Low Liquidity IV","High Liquidity OLS","High Liquidity IV"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))

```
## Anchoring

```{r anchoring_main_results}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]
temp$degree_of_overpricing <- temp$listing_amount/temp$current_value



dependent_var = "log(sales_price)"
endo_var = "degree_of_overpricing"
instrument = "log(property_tax_paid)"
cluster_var = "zip_listed_month"


controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[!temp$purchased_year %in% c(2004:2008),])
# regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"+zip_purchased_year|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
# regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[!temp$purchased_year %in% c(2004:2008),])
# regs[[6]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[!temp$purchased_year %in% c(2009:2012),])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","IV(excl 2004-08)","IV(2009-12)"),depvar = dependent_var,note = c("Fixed Effects: zip x purchased year, zip x listed year","Standard Errors clustered by zip x purchased year"),iv=instrument,list(condf))
```

## HPI Split
```{r anchoring_hpi_split}

dependent_var = "log(sales_price)"
endo_var = "degree_of_overpricing"
instrument = "log(property_tax_paid)"
cluster_var = "zip_listed_month"


controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_month"


regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi ,])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi  ,])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
# regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls0,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi & temp$purchased_year %in% c(2004:2011),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Loss-OLS","Loss-IV","No Loss-OLS","No Loss-IV"),depvar = dependent_var,note = c("Fixed Effects: zip * listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))

```

## Impact of Liquidity 

This table examines the relationship between list price and transaction price. This table reports regression statistics for an instrumental variable regression where log(Transaction Price) is the dependent variable, $$ \frac{listprice}{housevalue} $$ is the independent variable being instrumented for, and property tax rate is used as the instrument. Property tax rate is defined as $$ \frac{\text{Property taxes year before listing}}{House Value in listing year} $$. Sample is split in to three subsamples based on the for sale inventory. Low liquidity sample -> 1st, 2nd and 3rd Deciles. Med liquidity sample -> 4th through 7th decile. High liquidity -> 8 through 10 decile. 


```{r anchoring_liquidity_split}
dependent_var = "log(sales_price)"
endo_var = "degree_of_overpricing"
instrument = "log(property_tax_paid)"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Low Liquidity OLS","Low Liquidity IV","High Liquidity OLS","High Liquidity IV"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))

```

```{r}

temp <- sold_data[sold_data$state %in% c("CA") ,]


# rowno <- 1
pb <- txtProgressBar(min = 1, max = nrow(temp), initial = 1,style=3,char = ".")
for(i in 1:nrow(temp)) {
    setTxtProgressBar(pb, i)
    start = temp[i,]$purchased_year+2
    end = temp[i,]$listed_year-1
    if(end>start) {
      for(j in start:(end-1)) {
        try({
          eval(parse(text=paste("temp[i,'gr_",j,"']=temp[i,]$assesment_",j,"/temp[i,]$assesment_",(j-1),"-1",sep="")))
        })
        # tax_rate <- eval(parse(text=paste("temp[i,]$proptax_",j,"/temp[i,]$assesment_",j,sep="")))
        # if(length(appr)==0 | length(tax_rate)==0) next
        # if(is.na(appr) | is.na(tax_rate)) next
        # if(appr>0.022 | tax_rate>0.011 | tax_rate<=0 ) next
        # appr <- min(0.02,appr)
        # tax_rate <- min(0.01,tax_rate)
        # summarydata[rowno,] <- c(temp[i,]$zip,j,appr,tax_rate)
        # rowno = rowno+1
      }
    }

}



temp['prop8_affected'] <- ifelse((temp$gr_2008 < -0.05 |temp$gr_2009 < -0.05 | temp$gr_2010 < -0.0024 | temp$gr_2011 < 0.0075| temp$gr_2012 < 0.0) & (temp$gr_2013>0.02 | temp$gr_2014 >0.005), 1,0)


no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]
temp['list_purch_hpi'] <- temp$listed_hpi/temp$purchased_hpi


dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected!=1 | is.na(temp$prop8_affected),])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])



condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","IV(excl 2004-08)"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))

stargazer(temp[temp$prop8_affected!=1 |is.na(temp$prop8_affected), c("gr_2006","gr_2007","gr_2008","gr_2009","gr_2010","gr_2011","gr_2012","gr_2013","gr_2014","gr_2015")], type = output.type, summary.stat = c("p25", "median", "p75", "n"),notes = "",digits = 4)


```
