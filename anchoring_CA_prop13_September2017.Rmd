---
title: 'Sunk Costs and Anchoring in the Housing Market'
author: "Dimuthu Ratnadiwakara and Vijay Yerramilli"
date: "July, 2017"
output:
  html_document:
    css: bodycss.css
    fig_width: 8
    font-family: Helvetica,Arial,sans-serif;
    number_section: yes
    toc: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
linestretch: 2
bibliography: C:\Users\dnratnadiwakara\OneDrive\library.bib
---

<style type="text/css">
body{ 
      font-size: 15px;
      font-family: Helvetica,Arial,sans-serif;
      line-height: 200%;
  }
  
.author {
 font-size: 15px;
 color: Black;
 font-style: normal;
 text-align: center;
}


.date { 
 font-size: 15px;
 color: Black;
 font-style: normal;
 text-align: center;
}

.title{
  text-align: center;
  font-size: 15px;
 color: Black;
 
}

.toc-ignore{
  text-align: center;
  font-size: 15px;
 color: Black;
}

.fluid-row{
  text-align: center;
  font-size: 15px;
 color: Black;
}

</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE,echo = FALSE, fig.align='center')
```




```{r init}

rm(list=ls())
path = "E:/tax_incident/"
setwd(path)
library(plyr)
library(psych)
library(stargazer)
library(Matching)
library(sandwich)
library(ggplot2)
library(scales)
library(lubridate)
library(zoo)
library(AER)
library(lfe)
library(pracma)
library(dplyr)
library(ggmap)
library(reshape2)
library(np)
library(survival)


output.type="text"

completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

# sold_data <- readRDS(file="ca_anchoring_11.rds")
# library(zipcode)
# data("zipcode")
# zipcode <- zipcode[,c("zip","state")]
# zipcode$zip <- as.numeric(zipcode$zip)
# sold_data <- merge(sold_data,zipcode,by="zip")
# sold_data <- sold_data[sold_data$state %in% c("CA","IL"),]
# 
# sold_data <- sold_data[sold_data$state %in% c("CA"),]
# 
# 
# sold_data <- sold_data[sold_data$sales_price>=quantile(sold_data$sales_price,0.001,na.rm = TRUE) & sold_data$sales_price<=quantile(sold_data$sales_price,0.999,na.rm = TRUE),]
# sold_data['delete'] <- ifelse(sold_data$Lastremodelyear>sold_data$purchased_year,1,0)
# sold_data <- sold_data[sold_data$delete ==0 | is.na(sold_data$delete),]
# sold_data$delete <- NULL
# 
# sold_data <- sold_data[is.finite(log(sold_data$listing_amount)),]
# sold_data <- sold_data[is.finite(log(sold_data$sales_price)),]
# sold_data <- sold_data[!is.na(sold_data$zip_purchased_year),]
# sold_data <- sold_data[!is.na(sold_data$zip_listed_year),]
# sold_data <- sold_data[sold_data$listed_year>=2013,]
# 
# 
# 
# sold_data <- completeFun(sold_data,c("sales_price","listing_amount","zip_listed_year","purchased_amount","purchased_year"))
# saveRDS(sold_data,file = "sold_data_cleaned_11.rds")

note =c("Fixed Effects: zip x listed year","Standard Errors clustered by zip x listed year")
printtable <- function(reg,column.labels,depvar,note,iv,lines) {
  stargazer(reg,type=output.type,no.space = TRUE,omit.stat = c("f","rsq","ser"),notes= note,column.labels = column.labels, dep.var.labels = "",dep.var.caption   = paste("Y: ",gsub("_"," ",depvar),"; iv: ",gsub("_"," ",iv)),dep.var.labels.include = FALSE,add.lines = lines)
}

# sold_data <- readRDS(file = "sold_data_cleaned_11.rds")
# 
# sold_data['listed_tax'] <- ifelse(sold_data$listed_year>=2016,sold_data$proptax_2015,ifelse(sold_data$listed_year==2015,sold_data$proptax_2014,ifelse(sold_data$listed_year==2014,sold_data$proptax_2013,sold_data$proptax_2012)))
# 
# sold_data <- sold_data[!is.na(sold_data$listed_tax),]
# sold_data['estimated_current_value'] <- sold_data$current_value # current value = purchasedprice*hpi/hpi
# sold_data['degree_of_overpricing'] <- (sold_data$listing_amount / sold_data$estimated_current_value)
# sold_data['tax_pct'] <- sold_data$listed_tax/sold_data$estimated_current_value
# 
# sold_data <- sold_data[!(sold_data$listed_tax > quantile(sold_data$listed_tax,0.99,na.rm = TRUE) | sold_data$sales_price > quantile(sold_data$sales_price,0.99,na.rm = TRUE) | sold_data$listing_amount > quantile(sold_data$listing_amount,0.99,na.rm = TRUE) | sold_data$estimated_current_value > quantile(sold_data$estimated_current_value,0.99,na.rm = TRUE) | sold_data$listed_tax < quantile(sold_data$listed_tax,0.01,na.rm = TRUE) | sold_data$sales_price < quantile(sold_data$sales_price,0.01,na.rm = TRUE) | sold_data$listing_amount < quantile(sold_data$listing_amount,0.01,na.rm = TRUE) | sold_data$estimated_current_value < quantile(sold_data$estimated_current_value,0.01,na.rm = TRUE)), ]
# 
# sold_data <- sold_data[!is.na(sold_data$estimated_current_value),]
# 
# sold_data <- sold_data[sold_data$degree_of_overpricing>=quantile(sold_data$degree_of_overpricing,0.02,na.rm = TRUE) & sold_data$degree_of_overpricing<=quantile(sold_data$degree_of_overpricing,0.98,na.rm = TRUE) & sold_data$tax_pct>=quantile(sold_data$tax_pct,0.03,na.rm = TRUE) & sold_data$tax_pct<=quantile(sold_data$tax_pct,0.97,na.rm = TRUE),]
# 
# 
# inventory_data <- read.csv(paste("InventoryMeasure_Zip_Public.csv",sep=""))
# inventory_data <- data.frame(inventory_data[1],stack(inventory_data[2:ncol(inventory_data)]))
# names(inventory_data) <- c("month","inventory","zip")
# inventory_data$month <- as.Date(as.character(inventory_data$month))
# inventory_data$zip <- as.character(inventory_data$zip)
# inventory_data$zip <- as.integer(substr(inventory_data$zip,2,nchar(inventory_data$zip)))
# inventory_data['listed_year'] <- as.numeric(format(inventory_data$month,"%Y"))
# inventory_data <- inventory_data[inventory_data$zip %in% unique(sold_data[sold_data$state=="CA",]$zip),]
# inventory_data <- inventory_data[inventory_data$listed_year %in% unique(sold_data[sold_data$state=="CA",]$listed_year),]
# inventory_data <- ddply(inventory_data,.(listed_year,zip),summarise,inventory = mean(inventory,na.rm = TRUE))
# inventory_data['inventory_decile'] <- ntile(inventory_data$inventory, 10)
# 
# sold_data$inventory <- NULL
# sold_data$inventory_decile <- NULL
# 
# sold_data <- merge(sold_data,inventory_data,by=c("listed_year","zip"),all.x = TRUE)
# sold_data <- sold_data[sold_data$beds<8,]
# sold_data <- sold_data[sold_data$sqft<10000,]
# 
# sold_data['zip_listed_month'] <- paste(sold_data$zip,sold_data$listed_month)
# 
# 
# 
# 
# 
# 
# # rowno <- 1
# pb <- txtProgressBar(min = 1, max = nrow(sold_data), initial = 1,style=3,char = ".")
# for(i in 1:nrow(sold_data)) {
#     setTxtProgressBar(pb, i)
#     start = sold_data[i,]$purchased_year+2
#     end = sold_data[i,]$listed_year-1
#     if(is.na(start) | is.na(end)) next
#     if(start<=2004) next
#     if(end>start) {
#       for(j in start:(end-1)) {
# 
#         try({
#           eval(parse(text=paste("if(is.na(sold_data[i,]$assesment_",j,") | is.na(sold_data[i,]$assesment_",(j-1),")) next",sep="")))
#           eval(parse(text=paste("if(sold_data[i,]$assesment_",j,"==0 | sold_data[i,]$assesment_",(j-1),"==0) next",sep="")))
#           eval(parse(text=paste("sold_data[i,'gr_",j,"']=sold_data[i,]$assesment_",j,"/sold_data[i,]$assesment_",(j-1),"-1",sep="")))
#         },{})
#       }
#     }
# }
# 
# 
# # sold_data$gr_2005 <- floor(sold_data$gr_2005*1000)/1000
# # sold_data$gr_2006 <- floor(sold_data$gr_2006*1000)/1000
# # sold_data$gr_2007 <- floor(sold_data$gr_2007*1000)/1000
# # sold_data$gr_2008 <- floor(sold_data$gr_2008*1000)/1000
# # sold_data$gr_2009 <- floor(sold_data$gr_2009*1000)/1000
# # sold_data$gr_2010 <- floor(sold_data$gr_2010*1000)/1000
# # sold_data$gr_2011 <- floor(sold_data$gr_2011*1000)/1000
# # sold_data$gr_2012 <- floor(sold_data$gr_2012*1000)/1000
# # sold_data$gr_2013 <- floor(sold_data$gr_2013*1000)/1000
# # sold_data$gr_2014 <- floor(sold_data$gr_2014*1000)/1000
# # sold_data$gr_2015 <- floor(sold_data$gr_2015*1000)/1000
# 
# 
# sold_data['prop8_affected'] <- ifelse((sold_data$gr_2008 > 0.0 | is.na(sold_data$gr_2008) ) & (sold_data$gr_2009 >0 | is.na(sold_data$gr_2009)) & (sold_data$gr_2010 > -0.004 | is.na(sold_data$gr_2010)) & (sold_data$gr_2011 >0 | is.na(sold_data$gr_2011)) & (sold_data$gr_2012 <= 0.03 | is.na(sold_data$gr_2012)) & (sold_data$gr_2013 <= 0.03 | is.na(sold_data$gr_2013)) & (sold_data$gr_2014 <= 0.03 | is.na(sold_data$gr_2014)),0,1)
# 
# saveRDS(sold_data,file = "sold_data_cleaned_12_cleaned_1.1.rds")
# # sold_data['prop8_affected'] <- ifelse((sold_data$gr_2008 < -0.03 & !is.na(sold_data$gr_2008) ) & (sold_data$gr_2009 < -0.03 & !is.na(sold_data$gr_2009)) & (sold_data$gr_2010 <= -0.03 & !is.na(sold_data$gr_2010)) & (sold_data$gr_2011 < -0.03 & !is.na(sold_data$gr_2011)) & (sold_data$gr_2012 > 0.03 & !is.na(sold_data$gr_2012)) & (sold_data$gr_2013 >0.03 & !is.na(sold_data$gr_2013)) & (sold_data$gr_2014 >0.03 & !is.na(sold_data$gr_2014)),1,0)
# 
# pb <- txtProgressBar(min = 1, max = nrow(sold_data), initial = 1,style=3,char = ".")
# for(i in 1:nrow(sold_data)){
#   setTxtProgressBar(pb, i)
#   if(sold_data[i,]$prop8_affected==0) {
#     start = max(sold_data[i,]$purchased_year,2005)
#     end = sold_data[i,]$listed_year
#     if(is.na(start)) next
#     if(is.na(end)) next
#     for(yr in start:end) {
#       gr = 0.02
#       if(yr==2010) gr = -0.0024
#       if(yr==2011) gr = 0.0075
#       if(yr==2014) gr = 0.0045
#       gr_0 <- eval(parse(text=paste("sold_data[i,'gr_",yr,"'] ",sep="")))
#       if(length(gr_0)==0) gr_0 = gr
#       if(!is.na(gr_0)) gr = gr_0
#       eval(parse(text=paste("sold_data[i,'gr_",yr,"'] = ",gr,sep="")))
#     }
#   }
# }

# sold_data$sqft <- rnorm(nrow(sold_data),mean(sold_data$sqft,na.rm=TRUE),sd(sold_data$sqft,na.rm = TRUE))
# saveRDS(sold_data,file = "sold_data_cleaned_12_cleaned_2.rds")

sold_data<-readRDS(file = "sold_data_cleaned_12_cleaned_1.1.rds")

sold_data['nominal_loss'] <- sold_data$purchased_amount - sold_data$estimated_current_value
```


```{r mergeztrax}
path = "E:/ztrax/CA/06/ZAsmt/"
ztrax <- readRDS(file=paste(path,"Main.rds",sep=""))
```

```{r prop8identification}
year <- c(2004:2015)
infac <- c(1.01867,1.02,1.02,1.02,1.02,1.02,0.99763,1.00753,1.02,1.02,1.00454,1.01998)
inflation.factors <- data.frame(year,infac)

start = 2008
end = 2016

temp <- sold_data[sold_data$purchased_year==start & sold_data$listed_year>=end,]
temp <- temp[temp$prop8_affected==1,]

taxstring = "("
for(i in (start+1):(end-1)) {
  taxstring = paste(taxstring,"+temp$assesment_",i,sep="")
}
taxstring = paste(taxstring,")/100",sep="")
eval(parse(text=paste("temp['property_tax_paid'] <- ",taxstring,sep="")))


assessment_data <- matrix(nrow = nrow(temp)*15, ncol = 6)

rowno = 1
pb <- txtProgressBar(min = 1, max = nrow(temp), initial = 1)
for(i in 1:nrow(temp)) {
    setTxtProgressBar(pb, i)
    start = temp[i,]$purchased_year
    end = temp[i,]$listed_year-1
    purchased_amount = temp[i,]$purchased_amount 
    basevalue1 = temp[i,]$purchased_amount 
    basevalue2 = basevalue1 * inflation.factors[inflation.factors$year==(start+1),]$infac
    zip = temp[i,]$zip
    link  = temp[i,]$link
    if(is.na(start) | is.na(end)) next
    if(start<=2004) next
    tryCatch({
      # eval(parse(text=paste("assessment_data[rowno,] <- c(link,start,basevalue,temp[i,]$assesment_",start,")",sep="")))
      # rowno = rowno+1
    })
    end = min(end,2015)
    if(end>start) {
      # tryCatch({
        for(j in (start+1):(end)) {
          if(j==(start+1)) {
            eval(parse(text=paste("b1 = abs(basevalue1 - temp[i,]$assesment_",j,")",sep="")))
            eval(parse(text=paste("b2 = abs(basevalue1*inflation.factors[inflation.factors$year==start,]$infac-temp[i,]$assesment_",j,")",sep="")))
            eval(parse(text=paste("b3 = abs(basevalue2 - temp[i,]$assesment_",j,")",sep="")))
            eval(parse(text=paste("b4 = abs(basevalue2*inflation.factors[inflation.factors$year==start,]$infac-temp[i,]$assesment_",j,")",sep="")))
            minvalue = which(c(b1,b2,b3,b4)==min(b1,b2,b3,b4))[1]
            if(!is.na(b1) & !is.na(b2)) {
              if(minvalue==1) {
                basevalue = basevalue1
              }
              if(minvalue==2) {
                basevalue = basevalue1*inflation.factors[inflation.factors$year==start,]$infac 
              }
              if(minvalue==3) {
                basevalue = basevalue2
              }
              if(minvalue==4) {
                basevalue = basevalue2*inflation.factors[inflation.factors$year==start,]$infac 
              }
            }
          } else {
            basevalue = basevalue*inflation.factors[inflation.factors$year==j,]$infac  
          }
          
          eval(parse(text=paste("assessment_data[rowno,] <- c(link,zip,j,basevalue,temp[i,]$assesment_",j,",purchased_amount)",sep="")))
          rowno = rowno+1
        }
      # })
    }
}

assessment_data <- as.data.frame(assessment_data)
names(assessment_data)<- c("link","zip","year","prop13_assessment","actual_assessment","purchased_amount")
assessment_data <- data.frame(lapply(assessment_data, as.character), stringsAsFactors=FALSE)
assessment_data <- assessment_data[!is.na(assessment_data$link),]
assessment_data$year <- as.integer(assessment_data$year)
assessment_data$prop13_assessment <- as.numeric(assessment_data$prop13_assessment)
assessment_data$actual_assessment <- as.numeric(assessment_data$actual_assessment)
assessment_data$purchased_amount <- as.numeric(assessment_data$purchased_amount)

assessment_data <- assessment_data[!assessment_data$link %in% unique(assessment_data[assessment_data$actual_assessment==0,]$link),]
assessment_data['asmt_diff'] <- (assessment_data$prop13_assessment - assessment_data$actual_assessment)*100/assessment_data$prop13_assessment

assessment_data['diff'] <- assessment_data$prop13_assessment - assessment_data$actual_assessment

t3 <- ddply(assessment_data,.(link),summarise,diff = sum(diff,na.rm = TRUE),purchprice = min(purchased_amount,na.rm = TRUE))
t3['diff_pct'] <- t3$diff/(t3$purchprice*100)

temp <- merge(temp,t3,by="link")

dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "diff_pct"
cluster_var = "zip"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_year"


regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)


 condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV"),depvar = dependent_var,note = c(""),iv=instrument,list(condf))

t <- as.data.frame(table(assessment_data$zip))
t2 <- assessment_data[assessment_data$zip==93722,]
t2['diff'] <- t2$prop13_assessment - t2$actual_assessment
t2.2 <- ddply(t2,.(link),summarise,diff = sum(diff,na.rm = TRUE),purchprice = min(purchased_amount,na.rm = TRUE))
t2.2['diff_pct'] <- t2.2$diff/(t2.2$purchprice*100)
View(t2[t2$link %in% t2.2[c(6,8),]$link,])
```




## Descriptive Statistics

This table provides descriptive statistics of the main sample-a sample of recently sold houses in California.
```{r descriptivestats}
temp <- sold_data[sold_data$state %in% c("CA"),]
temp<- temp[is.finite(temp$degree_of_overpricing),]
temp<- temp[is.finite(log(temp$estimated_current_value)),]
temp['property_tax_paid'] <- ifelse(temp$purchased_year<=2011,temp$listed_tax*5,NA)
temp['list_price_adj_purch_price'] <- temp$listing_amount/temp$current_value
temp['list_price_trans_price'] <- temp$listing_amount/temp$sales_price
temp['prop_tax_adj_purch_price'] <- temp$property_tax_paid/temp$current_value
temp['list_hpi_purch_hpi'] <- temp$listed_hpi/temp$purchased_hpi
temp['years_since_remodel'] <- temp$listed_year - temp$Lastremodelyear
# temp <- temp[temp$degree_of_overpricing>=quantile(temp$degree_of_overpricing,0.02,na.rm = TRUE) & temp$degree_of_overpricing<=quantile(temp$degree_of_overpricing,0.98,na.rm = TRUE),]



stargazer(temp[, c("purchased_amount","current_value","listing_amount","sales_price","list_price_adj_purch_price","list_price_trans_price","property_tax_paid","prop_tax_adj_purch_price","prop8_affected","purchased_hpi","list_hpi_purch_hpi","ownership_years","years_since_remodel","beds","baths","sqft","avg_school_rating","avg_school_distance","age","Lot")], type = output.type, summary.stat = c("mean", "sd", "p25", "median", "p75", "n"),notes = "",digits = 4)
```

```{r within_zip_cor}
require(plyr)
correl <- function(xx)
{
return(data.frame(COR = cor(xx$purchased_hpi, xx$listed_hpi, use="pairwise.complete.obs")))
}

cor_group <- ddply(sold_data[,c("purchased_hpi","listed_hpi","zip")], .(zip), correl)
```


## Property Taxes and House Prices in California

This figure shows the relationship between the property tax rate in 2015 and the median house price in the zip code at the time of purchase in California. Tax rate is defined as the property taxes paid in 2015 as a percentage of estimated home value in 2015. Home value is estimated by inflating the purchased price by house price appreciation rate from purchased year to year 2015.

```{r ca_graph}
temp <- sold_data[sold_data$state %in% c("CA"),]
# temp <- temp[temp$tax_pct>=quantile(temp$tax_pct,0.05,na.rm = TRUE) & temp$tax_pct<=quantile(temp$tax_pct,0.95,na.rm = TRUE),]
temp['purchased_quarter'] <- as.yearqtr(temp$purchased_date)
temp <- temp[temp$purchased_year <=2011 ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp$property_tax_paid <- temp$property_tax_paid/temp$current_value
temp <- ddply(temp,.(purchased_quarter),summarise,proptax_2015 = mean(proptax_2015),estimated_current_value=mean(estimated_current_value),taxpct = mean(property_tax_paid*100),hpi=mean(purchased_hpi,na.rm=TRUE))
# stargazer((temp),summary = FALSE,type=output.type)
# temp <- temp[,c("purchased_year","taxpct","hpi")]
g1 <- ggplot(temp,aes(x=purchased_quarter))+ geom_line(aes(y=temp$taxpct,color="Tax Rate"))+ geom_line(aes(y=temp$hpi/100000,color="Median House Price"))+scale_linetype_manual(values = c(rep("solid", 1), rep("dashed", 1)))+ scale_y_continuous(sec.axis = sec_axis(~.*100, name = "Median House Price $'000"))+labs(y = "Tax Rate (%)",x = "Purchased Year",colour = NULL)+ theme_bw()+theme(legend.position="bottom",legend.direction="horizontal",legend.title=element_blank(),        axis.ticks.y=element_blank(),legend.key.width=unit(5,"line"),legend.key = element_blank())+ggtitle("")
g1
```



Following figure shows the histogram of within zip code tax rate variation. Tax rate for each house is calculated by dividing the property tax amount in the year prior to listing by the estimated house value in the year of listing. X-axis is the difference between the tax rate of each house and the mean tax rate of each zip code.

```{r hist_tax_pct}
temp <- sold_data[sold_data$state %in% c("CA") ,]
temp<- temp[is.finite(temp$degree_of_overpricing),]
temp<- temp[is.finite(log(temp$estimated_current_value)),]
temp <- temp[temp$purchased_year <=2011  ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp$tax_pct = temp$property_tax_paid/temp$current_value
zip_tax_rate <- ddply(temp,.(zip),summarise,mean_tax_rate = mean(tax_pct))
temp <- merge(temp,zip_tax_rate,by=c("zip"))
temp['tax_variation'] <- temp$tax_pct-temp$mean_tax_rate
q1<-qplot(temp$tax_variation,geom="histogram",xlab="Tax Rate - Mean ZIP Tax Rate",ylab="Number of Listings",col=I("black"))+ theme_bw()+xlim(-0.03,0.03)
q1
```


## Balancing Tests
```{r balancing_tests}


temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*1
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>1000 & temp$property_tax_paid <200000,]


dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

# temp <- temp[temp$degree_of_overpricing>=quantile(temp$degree_of_overpricing,0.02,na.rm = TRUE) & temp$degree_of_overpricing<=quantile(temp$degree_of_overpricing,0.98,na.rm = TRUE) & temp$tax_pct>=quantile(temp$tax_pct,0.02,na.rm = TRUE) & temp$tax_pct<=quantile(temp$tax_pct,0.98,na.rm = TRUE),]
temp['std_degree_of_overpricing']<- (temp$degree_of_overpricing - mean(temp$degree_of_overpricing,na.rm=TRUE))/sd(temp$degree_of_overpricing,na.rm=TRUE)
temp['std_tax_pct']<- (temp$tax_pct - mean(temp$tax_pct,na.rm=TRUE))/sd(temp$tax_pct,na.rm=TRUE)
temp$age <- abs(temp$age)+1
# temp['zip_listed_year']<- paste(temp$zip,as.yearqtr(temp$listed_date))
# temp['zip_purchased_year']<- paste(temp$zip,as.yearqtr(temp$purchased_date))

# formula_text <- "~0|zip_listed_year|(std_degree_of_overpricing~tax_pct)|zip_listed_year"
formula_text <- "|zip_listed_month|0|zip_listed_month"

temp$property_tax_paid <- temp$property_tax_paid/temp$estimated_current_value
variables <- c("beds","baths","sqft","Lot","age","log(sales_price)","log(purchased_hpi)","ownership_years")
i = 1
felm_regs <- list()
for(variable in variables) {
  # print(i)
  # if(variable == "purchased_hpi") {
  #   # temp <- temp[temp$degree_of_overpricing<1.5 & temp$degree_of_overpricing>0.55,]
  #   temp <- temp[temp$tax_pct<0.2 & temp$tax_pct>0.0001,]
  #   # temp <- rbind(temp,temp[sample(nrow(temp), 9000), ])
  # }
  felm_regs[[i]] <- felm(as.formula(paste("I(property_tax_paid*100)~",variable,formula_text,sep="")),data=temp)
  i=i+1
}

stargazer(felm_regs,type = output.type,no.space = TRUE,column.labels = gsub("_","",variables),notes = note,omit.stat = c("rsq"))
```


# Results

## Sunk Cost



### Sunk Cost Paper Tables

```{r sunk_cost_panel_A}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>0 & temp$property_tax_paid <2000000,]
temp['list_purch_hpi'] <- temp$listed_hpi/temp$purchased_hpi
temp['ownership_days'] <- as.numeric(temp$listed_date - temp$purchased_date)



dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+log(ownership_days)"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"
controls2 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"


regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~prop8_affected+",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==0,])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","Prop.8 = 0","Prop.8 = 1"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```


```{r sunk_cost_panel_A_robustness}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]
temp['list_purch_hpi'] <- temp$listed_hpi/temp$purchased_hpi
temp['purchased_quarter'] <- as.yearqtr(temp$purchased_date)
temp['ownership_days'] <- as.numeric(temp$listed_date - temp$purchased_date)

# temp <- completeFun(temp,c("sales_price","beds","baths","sqft","zip_listed_year","purchased_amount","purchased_hpi","Lot","walk_score","avg_school_rating","avg_school_distance","zip_purchased_year","age"))
purchased_price_estimate <- felm(purchased_amount~age+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|factor(zip_purchased_year),data=temp)
temp['purchase_price_residual'] <- purchased_price_estimate$residuals

sales_price_estimate <- felm(sales_price~age+sqft+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance+listed_hpi|zip+listed_month,data=temp)
# temp$predicted_sales_price <- sales_price_estimate$fitted.values
temp['loss'] <- temp$purchased_amount - temp$predicted_sales_price



prop_tax_paid_reg <- felm(property_tax_paid~loss+log(predicted_sales_price)+I(purchase_price_residual*100000)+log(ownership_days)+log(listed_hpi)|zip+listed_month,data=temp)

temp['prop_tax_resid'] <- prop_tax_paid_reg$residuals

dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
# endo_var = "I(prop_tax_resid/1e4)"
instrument = "log(purchased_hpi)+ownership_days"
instrument1 = "log(purchased_hpi)"
cluster_var = "zip_listed_month"


controls2 <- "log(loss)+log(predicted_sales_price)+I(purchase_price_residual*100000)+log(list_purch_hpi)|zip+listed_year"


temp$loss <- abs(temp$loss)
regs <- list()

regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi,])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi,])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<temp$listed_hpi,])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<temp$listed_hpi,])

# regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi,])
# 
# regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<temp$listed_hpi,])
# regs[[4]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi,])

# condf <- c("Cond. F. Stat",round(condfstat(regs[[1]])[[1]],2),round(condfstat(regs[[2]])[[1]],2),round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("OLS Loss","IV Loss","OLS Non Loss","IV Non Loss"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(""))
```

```{r sunk_cost_panel_A_split_by_year}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]
temp['ownership_days'] <- as.numeric(temp$listed_date - temp$purchased_date)
instrument = "log(purchased_hpi)+ownership_days"



years <- c(2004:2011)
cluster_var = "0"

controls <- "log(estimated_current_value)+age+beds+baths+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_year"
i = 1
regs <- list()
for(yr in years){
  temp$property_tax_paid <- temp$listed_tax*(2016-yr)
  regs[[i]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_year==yr & temp$listed_year>=2014,])
  i=i+1
}

# regs[[1]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~ownership_days)|",cluster_var,sep="")),data = temp[temp$purchased_year<=1997 & temp$listed_year>=2014,])

printtable(regs,c(as.character(years)),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(""))
```

```{r sunk_cost_panel_B}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

temp$degree_of_overpricing <- temp$listing_amount/temp$estimated_current_value
temp$tax_rate <- temp$property_tax_paid/temp$estimated_current_value

dependent_var = "degree_of_overpricing"
endo_var = "tax_rate"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~prop8_affected+",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==0,])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","Prop.8 = 0","Prop.8 = 1"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```

```{r sunk_cost_panel_C}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

temp$degree_of_overpricing <- temp$listing_amount/temp$sales_price
temp$tax_rate <- temp$property_tax_paid/temp$sales_price

dependent_var = "degree_of_overpricing"
endo_var = "tax_rate"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_year"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==0,])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","Prop.8 = 0","Prop.8 = 1"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```

```{r sunk_cost_loss_split}

setwd(path)

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument1 = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls1 <- "log(estimated_current_value)+prop8_affected+nominal_loss+I(sqft^2)+age+baths+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"
controls2 <- "log(estimated_current_value)+prop8_affected+nominal_loss+I(sqft^2)+age+baths+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

# hpi <- read.csv("Zip_Zhvi_SingleFamilyResidence.csv")
# hpi <- data.frame(hpi[2], stack(hpi[8:ncol(hpi)]))
# names(hpi)<-c("zip","2009_hpi","month")
# hpi <- hpi[hpi$zip %in% unique(temp$zip),]
# hpi$month <- as.Date(paste(substr(hpi$month,2,5),substr(hpi$month,7,8),"01",sep = "-"))
# hpi <- hpi[hpi$month>="2009-09-01" & hpi$month <="2009-12-31",]
# hpi['hpi_2009']<- hpi$`2009_hpi`
# hpi <- ddply(hpi,.(zip),summarise,hpi_2009 = mean(hpi_2009))
# temp <- merge(temp,hpi,by="zip")

instrument2 = "log(purchased_hpi)+ownership_years"
cluster_var = "listed_month"

# controls0 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year+zip_purchased_year"
# controls1 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year"
# controls2 <- "log(estimated_current_value)+sqft+age+beds+baths+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi ,])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument2,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi  ,])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls1,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls1,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
# regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls0,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi & temp$purchased_year %in% c(2004:2011),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Loss-OLS","Loss-IV","No Loss-OLS","No Loss-IV"),depvar = dependent_var,note = c("Fixed Effects: listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))


```


```{r sunk_cost_liquidity_split}
temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+prop8_affected+nominal_loss+I(sqft^2)+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Low Liquidity OLS","Low Liquidity IV","High Liquidity OLS","High Liquidity IV"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list("condf"))

```

```{r sunk_cost_on_transaction_price}
temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>0 & temp$property_tax_paid <200000,]


dependent_var = "log(sales_price)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

controls <- "log(predicted_sales_price)+age+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"


controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"


regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+prop8_affected+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~prop8_affected+",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==0,])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","Prop.8 = 0","Prop.8 = 1"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```

```{r proptax_on_transprice_hpi_split}
setwd(path)

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

dependent_var = "log(sales_price)"
endo_var = "log(property_tax_paid)"
instrument1 = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls1 <- "log(estimated_current_value)+prop8_affected+age+baths+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"
controls2 <- "log(estimated_current_value)+prop8_affected+age+baths+beds+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

# hpi <- read.csv("Zip_Zhvi_SingleFamilyResidence.csv")
# hpi <- data.frame(hpi[2], stack(hpi[8:ncol(hpi)]))
# names(hpi)<-c("zip","2009_hpi","month")
# hpi <- hpi[hpi$zip %in% unique(temp$zip),]
# hpi$month <- as.Date(paste(substr(hpi$month,2,5),substr(hpi$month,7,8),"01",sep = "-"))
# hpi <- hpi[hpi$month>="2009-09-01" & hpi$month <="2009-12-31",]
# hpi['hpi_2009']<- hpi$`2009_hpi`
# hpi <- ddply(hpi,.(zip),summarise,hpi_2009 = mean(hpi_2009))
# temp <- merge(temp,hpi,by="zip")

instrument2 = "log(purchased_hpi)+ownership_years"
cluster_var = "listed_month"

# controls0 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year+zip_purchased_year"
# controls1 <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year"
# controls2 <- "log(estimated_current_value)+sqft+age+beds+baths+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_year"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls2,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi ,])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls2,"|(",endo_var,"~",instrument2,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi  ,])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls1,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls1,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
# regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls0,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi & temp$purchased_year %in% c(2004:2011),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Loss-OLS","Loss-IV","No Loss-OLS","No Loss-IV"),depvar = dependent_var,note = c("Fixed Effects: listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))
```

```{r proptax_on_transprice_liquidity_split}
temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]

dependent_var = "log(sales_price)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+prop8_affected+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Low Liquidity OLS","Low Liquidity IV","High Liquidity OLS","High Liquidity IV"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))

```
## Anchoring

```{r anchoring_main_results}

temp <- sold_data[sold_data$state %in% c("CA") ,]
no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]
temp$degree_of_overpricing <- temp$listing_amount/temp$current_value



dependent_var = "log(sales_price)"
endo_var = "degree_of_overpricing"
instrument = "log(property_tax_paid)"
cluster_var = "zip_listed_month"


controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[!temp$purchased_year %in% c(2004:2008),])
# regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"+zip_purchased_year|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
# regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[!temp$purchased_year %in% c(2004:2008),])
# regs[[6]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[!temp$purchased_year %in% c(2009:2012),])


condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","IV(excl 2004-08)","IV(2009-12)"),depvar = dependent_var,note = c("Fixed Effects: zip x purchased year, zip x listed year","Standard Errors clustered by zip x purchased year"),iv=instrument,list(condf))
```

## HPI Split
```{r anchoring_hpi_split}

dependent_var = "log(sales_price)"
endo_var = "degree_of_overpricing"
instrument = "log(property_tax_paid)"
cluster_var = "zip_listed_month"


controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|listed_month"


regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi ,])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi>temp$listed_hpi  ,])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi ,])
# regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls0,"|(",endo_var,"~",instrument1,")|",cluster_var,sep="")),data = temp[temp$purchased_hpi<=temp$listed_hpi & temp$purchased_year %in% c(2004:2011),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Loss-OLS","Loss-IV","No Loss-OLS","No Loss-IV"),depvar = dependent_var,note = c("Fixed Effects: zip * listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))

```

## Impact of Liquidity 

This table examines the relationship between list price and transaction price. This table reports regression statistics for an instrumental variable regression where log(Transaction Price) is the dependent variable, $$ \frac{listprice}{housevalue} $$ is the independent variable being instrumented for, and property tax rate is used as the instrument. Property tax rate is defined as $$ \frac{\text{Property taxes year before listing}}{House Value in listing year} $$. Sample is split in to three subsamples based on the for sale inventory. Low liquidity sample -> 1st, 2nd and 3rd Deciles. Med liquidity sample -> 4th through 7th decile. High liquidity -> 8 through 10 decile. 


```{r anchoring_liquidity_split}
dependent_var = "log(sales_price)"
endo_var = "degree_of_overpricing"
instrument = "log(property_tax_paid)"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[2]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(1,2,3,4,5,6,7),])
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$inventory_decile %in% c(8,9,10),])


condf <- c("Cond. F. Stat","",round(condfstat(regs[[2]])[[1]],2),"",round(condfstat(regs[[4]])[[1]],2))

printtable(regs,c("Low Liquidity OLS","Low Liquidity IV","High Liquidity OLS","High Liquidity IV"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))

```

```{r}

temp <- sold_data[sold_data$state %in% c("CA") ,]


# rowno <- 1
pb <- txtProgressBar(min = 1, max = nrow(temp), initial = 1,style=3,char = ".")
for(i in 1:nrow(temp)) {
    setTxtProgressBar(pb, i)
    start = temp[i,]$purchased_year+2
    end = temp[i,]$listed_year-1
    if(end>start) {
      for(j in start:(end-1)) {
        try({
          eval(parse(text=paste("temp[i,'gr_",j,"']=temp[i,]$assesment_",j,"/temp[i,]$assesment_",(j-1),"-1",sep="")))
        })
        # tax_rate <- eval(parse(text=paste("temp[i,]$proptax_",j,"/temp[i,]$assesment_",j,sep="")))
        # if(length(appr)==0 | length(tax_rate)==0) next
        # if(is.na(appr) | is.na(tax_rate)) next
        # if(appr>0.022 | tax_rate>0.011 | tax_rate<=0 ) next
        # appr <- min(0.02,appr)
        # tax_rate <- min(0.01,tax_rate)
        # summarydata[rowno,] <- c(temp[i,]$zip,j,appr,tax_rate)
        # rowno = rowno+1
      }
    }

}



temp['prop8_affected'] <- ifelse((temp$gr_2008 < -0.05 |temp$gr_2009 < -0.05 | temp$gr_2010 < -0.0024 | temp$gr_2011 < 0.0075| temp$gr_2012 < 0.0) & (temp$gr_2013>0.02 | temp$gr_2014 >0.005), 1,0)


no_of_years = 5
temp['property_tax_paid'] <- temp$listed_tax*no_of_years
temp <- temp[temp$purchased_year<=(2016-no_of_years),]
temp <- temp[temp$property_tax_paid>5000 & temp$property_tax_paid <200000,]
temp['list_purch_hpi'] <- temp$listed_hpi/temp$purchased_hpi


dependent_var = "log(listing_amount)"
endo_var = "log(property_tax_paid)"
instrument = "log(purchased_hpi)+ownership_years"
cluster_var = "zip_listed_month"

controls <- "log(estimated_current_value)+sqft+age+beds+baths+Lot+walk_score+walk_score+avg_school_rating+avg_school_distance|zip_listed_month"

regs <- list()
regs[[1]] <- felm(as.formula(paste(dependent_var,"~",endo_var,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[2]] <- felm(as.formula(paste(endo_var,"~",instrument,"+",controls,"|0|",cluster_var,sep="")),data = temp)
regs[[3]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp)
regs[[4]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected!=1 | is.na(temp$prop8_affected),])
regs[[5]] <- felm(as.formula(paste(dependent_var,"~",controls,"|(",endo_var,"~",instrument,")|",cluster_var,sep="")),data = temp[temp$prop8_affected==1,])



condf <- c("Cond. F. Stat","","",round(condfstat(regs[[3]])[[1]],2),round(condfstat(regs[[4]])[[1]],2),round(condfstat(regs[[5]])[[1]],2))

printtable(regs,c("OLS","First Stage","IV","IV(excl 2004-08)"),depvar = dependent_var,note = c("Fixed Effects: zip x listed month","Standard Errors clustered by zip x listed month"),iv=instrument,list(condf))

stargazer(temp[temp$prop8_affected!=1 |is.na(temp$prop8_affected), c("gr_2006","gr_2007","gr_2008","gr_2009","gr_2010","gr_2011","gr_2012","gr_2013","gr_2014","gr_2015")], type = output.type, summary.stat = c("p25", "median", "p75", "n"),notes = "",digits = 4)


```
